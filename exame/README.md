# Система интернет-магазина на C++17

## Оглавление

1. [Описание задачи](#описание-задачи)  
2. [Архитектура проекта](#архитектура-проекта)  
3. [Структура базы данных](#структура-базы-данных)  
4. [Умные указатели и STL](#умные-указатели-и-stl)  
5. [Система ролей и прав доступа](#система-ролей-и-прав-доступа)  
6. [Аудит и логирование](#аудит-и-логирование)  
7. [Примеры SQL запросов](#примеры-sql-запросов)  
8. [Сборка и запуск](#сборка-и-запуск)  
9. [Структура проекта](#структура-проекта)  
10. [Использованные техники](#использованные-техники)  
11. [Контакты](#контакты)  

---

## Описание задачи

Разработана система интернет-магазина на C++17 с использованием PostgreSQL и клиентской библиотеки libpqxx.  
Проект демонстрирует архитектуру прикладной системы с разделением на слои, корректной работой с памятью и полноценной реляционной базой данных.  

Основные цели:  
- Показать применение принципов ООП (наследование, полиморфизм, инкапсуляция, композиция, агрегация).  
- Продемонстрировать управление ресурсами через умные указатели (RAII-подход).  
- Использовать STL‑контейнеры и алгоритмы для работы с коллекциями доменных объектов.  
- Спроектировать и реализовать схему БД PostgreSQL с индексами, триггерами, функциями и процедурами.  
- Реализовать аудит действий пользователей и историю изменения статусов заказов.  

Функциональность системы:  
- Управление каталогом товаров (создание, изменение, удаление, просмотр).  
- Создание заказов, добавление в них товаров и изменение статусов.  
- Разные способы оплаты (паттерн Strategy).  
- Проверка возможности возврата товара (ограничение по сроку).  
- Ведение аудита всех ключевых операций (insert/update/delete/payment/return).  

---

## Архитектура проекта

### Основные классы

Пользователи и роли:  
- User — абстрактный базовый класс для всех типов пользователей.  
- Admin — администратор системы (полный доступ к товарам, заказам и аудиту).  
- Manager — менеджер (обработка заказов и платежей, контроль остатков).  
- Customer — покупатель (создание заказов, оплата, возвраты, просмотр своих заказов).  

Доменные сущности:  
- Product — товар (наименование, цена, остаток, категория).  
- Order — заказ (товары, сумма, статус, пользователь).  
- OrderItem — позиция заказа (товар, количество, цена).  
- Payment — платёж по заказу.  

Оплата (паттерн Strategy):  
- PaymentStrategy — абстрактная стратегия оплаты.  
- CardPayment — оплата банковской картой.  
- WalletPayment — оплата электронным кошельком.  
- SBPPayment — оплата через систему быстрых платежей (СБП).  

Работа с БД:  
- DatabaseConnection<T> — шаблонный класс-обёртка над соединением с PostgreSQL, инкапсулирующий подключение, транзакции и выполнение запросов.  

### Взаимоотношения классов

- User агрегирует коллекцию заказов (`std::vector<std::shared_ptr<Order>>`).  
- Order композитно владеет элементами OrderItem и объектом Payment.  
- Payment композитно владеет реализацией PaymentStrategy.  

Используются:  
- Наследование (`Admin`, Manager, Customer от `User`).  
- Полиморфизм (виртуальные методы для меню и операций с заказами, стратегии оплаты).  
- Композиция (жизненный цикл OrderItem и Payment привязан к `Order`).  
- Агрегация (пользователь ссылается на свои заказы через `shared_ptr`).  

---

## Структура базы данных

### Таблица users
CREATE TABLE users (
    user_id       SERIAL PRIMARY KEY,
    name          VARCHAR(100) NOT NULL,
    email         VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role          VARCHAR(20) NOT NULL,  -- admin, manager, customer
    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
Хранит данные о пользователях и их ролях.

Таблица productsCREATE TABLE products (
    product_id        SERIAL PRIMARY KEY,
    name              VARCHAR(100) NOT NULL,
    description       TEXT,
    price             NUMERIC(10, 2) CHECK (price > 0),
    quantity_in_stock INT DEFAULT 0 CHECK (quantity_in_stock >= 0),
    category          VARCHAR(50),
    created_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

- Изменение статуса заказов, проведение платежей.
- Контроль остатков и выявление товаров с низким количеством.

Ограничения:

- Нет прав на создание/удаление пользователей.
- Нет полного доступа к аудиту и настройке системы.

### Покупатель (Customer)

Возможности:

- Создание собственных заказов и добавление товаров.
- Оплата заказов через выбранную стратегию (`Card`, Wallet, `SBP`).
- Просмотр своих заказов и отслеживание статуса.
- Возврат товаров при соблюдении условий (например, не позднее 30 дней).

Ограничения:

- Нет доступа к чужим заказам.
- Нет управления товарами и пользователями.

---

## Аудит и логирование

Система поддерживает централизованный аудит всех ключевых операций.

### Триггеры в БД

Для таблиц orders, products, payments и других создаются триггеры, которые при вставке, обновлении или удалении записывают данные в таблицу audit_log.

Примеры действий, попадающих в аудит:

- Создание заказа и изменение его статуса.
- Создание, обновление и удаление товара.
- Проведение платежей и возвратов.

### Типичные запросы к аудиту

- Получение аудита по конкретному пользователю.
- Просмотр истории изменений статусов определённого заказа.
- Анализ активности за заданный период (по датам/интервалам).


Примеры SQL запросов
Информация о заказах-- Все заказы пользователя
SELECT *
FROM orders
WHERE user_id = :user_id
ORDER BY order_date DESC;

-- Детали конкретного заказа
SELECT
    o.order_id,
    o.order_date,
    o.status,
    p.name       AS product_name,
    oi.quantity,
    oi.unit_price,
    oi.quantity * oi.unit_price AS line_total
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p     ON oi.product_id = p.product_id
WHERE o.order_id = :order_id;
Популярные товарыSELECT
    p.product_id,
    p.name,
    COUNT(oi.order_item_id)         AS purchase_count,
    SUM(oi.quantity)                AS total_sold,
    SUM(oi.quantity * oi.unit_price) AS total_revenue
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
GROUP BY p.product_id, p.name
ORDER BY total_revenue DESC
LIMIT 10;
Статистика по пользователю
sql
SELECT
    u.name,
    COUNT(o.order_id)      AS order_count,
    SUM(o.total_amount)    AS total_spent,
    AVG(o.total_amount)    AS avg_order_value
FROM orders o
JOIN users u ON o.user_id = u.user_id
WHERE u.user_id = :user_id
GROUP BY u.name;
## Сборка и запуск

### Требования

- C++17‑совместимый компилятор (GCC, Clang или MSVC).
- CMake 3.10+ для конфигурации и сборки.
- PostgreSQL 12+ и библиотека libpqxx.

### Общая схема

1. Установить PostgreSQL и libpqxx.
2. Создать пользователя и базу данных для интернет‑магазина.
3. Последовательно выполнить SQL‑скрипты:
   - создание таблиц;
   - функции и процедуры;
   - триггеры;
   - тестовые данные.
4. Собрать проект через CMake.
5. Запустить бинарный файл (`OnlineShop` / `OnlineShop.exe`).

---

## Использованные техники

- ООП: наследование, полиморфизм, инкапсуляция, композиция, агрегация.
- Управление памятью: std::unique_ptr, std::shared_ptr, RAII.
- STL: std::vector, std::map, std::set и алгоритмы find_if, copy_if, accumulate.
- Паттерны проектирования: Strategy, частично MVC‑подход, RAII.
- Работа с БД: транзакции, хранимые процедуры, функции, триггеры, индексы.
